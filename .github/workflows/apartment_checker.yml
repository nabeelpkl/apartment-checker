name: Apartment Availability Checker

on:
  schedule:
    # Run daily at 5:30 PM (17:30 UTC)
    - cron: '30 17 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-apartments:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        
    - name: Clear any cached files
      run: |
        rm -f apartment_results.txt
        rm -f debug_response_*.html
        
    - name: Run apartment checker and capture output
      id: apartment_check
      run: |
        echo "Starting apartment check at $(date)"
        python apartments.py > apartment_results.txt 2>&1
        echo "Script completed. Results:"
        cat apartment_results.txt
        echo "results<<EOF" >> $GITHUB_OUTPUT
        cat apartment_results.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Upload debug HTML files
      uses: actions/upload-artifact@v4
      with:
        name: debug-html
        path: debug_response_*.html
        if-no-files-found: warn
        
    - name: Create summary
      run: |
        echo "## Apartment Availability Report" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Location:** Muhaisnah Fourth" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check completed successfully!" >> $GITHUB_STEP_SUMMARY
        
    - name: Send Telegram notification
      if: always()
      run: |
        RESULTS=$(cat apartment_results.txt)
        echo "Sending Telegram notification with results:"
        echo "$RESULTS"
        
        # Check if all requests were blocked by CAPTCHA
        if echo "$RESULTS" | grep -q "âš ï¸ CAPTCHA detected" && echo "$RESULTS" | grep -c "âš ï¸ CAPTCHA detected" | grep -q "3"; then
          MESSAGE="ğŸ  *Website Blocking Automated Requests*%0A%0AğŸ“ *Location:* Muhaisnah Fourth%0AğŸ“… *Date:* $(date '+%Y-%m-%d')%0Aâ° *Time:* $(date '+%H:%M')%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A%0Aâš ï¸ *Status:* The WASL website is currently blocking automated requests with CAPTCHA protection.%0A%0AğŸ” *What this means:*%0Aâ€¢ The website detected automated access%0Aâ€¢ All apartment searches were blocked%0Aâ€¢ This is a temporary protection measure%0A%0AğŸ’¡ *Next steps:*%0Aâ€¢ Try again later when the protection is relaxed%0Aâ€¢ Check manually on the website if needed%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        elif echo "$RESULTS" | grep -q "âœ….*listing(s) found"; then
          MESSAGE="ğŸ  *NEW APARTMENTS AVAILABLE!*%0A%0AğŸ“ *Location:* Muhaisnah Fourth%0AğŸ“… *Date:* $(date '+%Y-%m-%d')%0Aâ° *Time:* $(date '+%H:%M')%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A%0A$RESULTS%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          MESSAGE="ğŸ  *Apartment Check Complete*%0A%0AğŸ“ *Location:* Muhaisnah Fourth%0AğŸ“… *Date:* $(date '+%Y-%m-%d')%0Aâ° *Time:* $(date '+%H:%M')%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A%0A$RESULTS%0A%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
        curl -s -X POST "https://api.telegram.org/bot7508698254:AAFnqGJxmyvvPcMHi_kqq2CNwa9DIH3JYDM/sendMessage" -d "chat_id=155536199&text=$MESSAGE&parse_mode=Markdown" 